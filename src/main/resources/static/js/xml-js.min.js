const XMLjs = (() => {
    // JS对象转XML字符串
    function js2xml(obj, options = {}) {
        // 默认配置
        const defaultOptions = {
            compact: true,
            spaces: 2,
            root: { name: 'root' },
            elementNameFn: (key) => key
        };
        const opts = { ...defaultOptions, ...options };

        // 处理数组
        function processArray(arr, parentKey) {
            let xml = '';
            const itemKey = opts.arrayItemKey || parentKey.slice(0, -1) || 'item';
            arr.forEach(item => {
                xml += processValue(item, itemKey);
            });
            return xml;
        }

        // 处理对象
        function processObject(obj, key) {
            let xml = '';
            const elementName = opts.elementNameFn(key);
            // 开始标签
            xml += indent(`<${elementName}>`, opts.spaces);
            // 处理子属性
            for (const prop in obj) {
                if (obj.hasOwnProperty(prop)) {
                    xml += processValue(obj[prop], prop);
                }
            }
            // 结束标签
            xml += indent(`</${elementName}>`, opts.spaces);
            return xml;
        }

        // 处理基本类型（字符串、数字、布尔）
        function processPrimitive(value, key) {
            const elementName = opts.elementNameFn(key);
            const escapedValue = escapeXml(value.toString());
            return indent(`<${elementName}>${escapedValue}</${elementName}>`, opts.spaces);
        }

        // 处理值（分支逻辑）
        function processValue(value, key) {
            if (Array.isArray(value)) {
                return processArray(value, key);
            } else if (typeof value === 'object' && value !== null) {
                return processObject(value, key);
            } else {
                return processPrimitive(value, key);
            }
        }

        // XML缩进
        function indent(str, spaces) {
            if (!spaces) return str;
            return '\n' + ' '.repeat(spaces) + str;
        }

        // XML特殊字符转义
        function escapeXml(str) {
            return str.replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&apos;');
        }

        // 生成XML头部
        let xml = '<?xml version="1.0" encoding="UTF-8"?>';

        // 处理紧凑模式（根节点包裹）
        if (opts.compact) {
            const rootName = opts.root.name;
            xml += indent(`<${rootName}>`, opts.spaces);
            // 处理根节点下的内容
            if (Array.isArray(obj)) {
                xml += processArray(obj, rootName);
            } else if (typeof obj === 'object' && obj !== null) {
                for (const key in obj) {
                    if (obj.hasOwnProperty(key)) {
                        xml += processValue(obj[key], key);
                    }
                }
            } else {
                xml += processPrimitive(obj, 'value');
            }
            xml += indent(`</${rootName}>`, opts.spaces);
        } else {
            // 非紧凑模式（直接处理顶层对象）
            xml += processValue(obj, opts.root.name);
        }

        return xml;
    }

    return {
        js2xml
    };
})();
