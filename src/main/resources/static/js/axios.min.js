const axios = (() => {
    // 工具函数：处理请求参数
    function processParams(params) {
        if (!params) return '';
        const arr = [];
        for (const key in params) {
            if (params.hasOwnProperty(key)) {
                arr.push(`${encodeURIComponent(key)}=${encodeURIComponent(params[key])}`);
            }
        }
        return arr.join('&');
    }

    // 工具函数：解析JSON响应
    function parseResponse(response) {
        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
            return response.json();
        }
        return response.text();
    }

    // 核心请求函数
    function request(config) {
        // 默认配置
        const defaultConfig = {
            method: 'GET',
            url: '',
            params: null,
            data: null,
            headers: {
                'Content-Type': 'application/json'
            },
            timeout: 10000
        };

        // 合并配置
        const finalConfig = { ...defaultConfig, ...config };

        // 处理URL参数（GET请求）
        let url = finalConfig.url;
        const paramsStr = processParams(finalConfig.params);
        if (paramsStr) {
            url += (url.includes('?') ? '&' : '?') + paramsStr;
        }

        // 创建AbortController处理超时
        const controller = new AbortController();
        const timeoutId = setTimeout(() => {
            controller.abort();
            reject(new Error('Request timeout'));
        }, finalConfig.timeout);

        // 返回Promise
        return new Promise((resolve, reject) => {
            fetch(url, {
                method: finalConfig.method,
                headers: finalConfig.headers,
                body: finalConfig.data ? JSON.stringify(finalConfig.data) : null,
                signal: controller.signal
            })
            .then(response => {
                clearTimeout(timeoutId);
                if (!response.ok) {
                    // 处理HTTP错误（4xx/5xx）
                    return parseResponse(response).then(data => {
                        reject({
                            status: response.status,
                            statusText: response.statusText,
                            data
                        });
                    });
                }
                return parseResponse(response);
            })
            .then(data => {
                resolve(data);
            })
            .catch(error => {
                clearTimeout(timeoutId);
                reject(error);
            });
        });
    }

    // 封装GET请求
    function get(url, params, config = {}) {
        return request({ ...config, method: 'GET', url, params });
    }

    // 封装POST请求
    function post(url, data, config = {}) {
        return request({ ...config, method: 'POST', url, data });
    }

    // 封装PUT请求
    function put(url, data, config = {}) {
        return request({ ...config, method: 'PUT', url, data });
    }

    return {
        request,
        get,
        post,
        put,
        defaults: {
            headers: {
                common: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            }
        }
    };
})();
