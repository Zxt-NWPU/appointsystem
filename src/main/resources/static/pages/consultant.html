<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>咨询师信息管理</title>
    <!-- 引入样式资源 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
<div class="container mt-5" id="consultantApp">
    <h2 class="mb-4 text-primary">咨询师信息管理</h2>
    
    <!-- 筛选器 -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <label class="form-label">咨询师类型</label>
                    <select class="form-select" v-model="filterType" @change="filterConsultants">
                        <option value="0">全部</option>
                        <option value="1">大学咨询师</option>
                        <option value="2">企业咨询师</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">搜索</label>
                    <input type="text" class="form-control" v-model="searchKeyword" @input="filterConsultants" placeholder="输入姓名、电话或学校/企业">
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <button class="btn btn-outline-secondary" @click="resetFilter">重置筛选</button>
                    <span class="ms-3 text-muted">共 {{ filteredConsultants?.length || 0 }} 条记录</span>
                </div>
            </div>
        </div>
    </div>

    <!-- 咨询师列表 -->
    <div class="row">
        <div class="col-md-6 mb-4" v-for="consultant in filteredConsultants" :key="consultant.id">
            <div class="card h-100 shadow-sm">
                <div class="card-header" :class="consultant.type === 1 ? 'bg-primary text-white' : 'bg-success text-white'">
                    <h5 class="mb-0">
                        <span class="badge" :class="consultant.type === 1 ? 'bg-light text-primary' : 'bg-light text-success'">
                            {{ consultant.type === 1 ? '大学咨询师' : '企业咨询师' }}
                        </span>
                        {{ consultant.name }}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-2">
                        <strong>身份证号：</strong>{{ maskIdCard(consultant.idCard) }}
                    </div>
                    <div class="mb-2">
                        <strong>联系电话：</strong>{{ consultant.phone }}
                    </div>
                    <div class="mb-2" v-if="consultant.type === 1 && consultant.school">
                        <strong>所在学校：</strong>{{ consultant.school }}
                    </div>
                    <div class="mb-2" v-if="consultant.type === 2 && consultant.company">
                        <strong>所在企业：</strong>{{ consultant.company }}
                    </div>
                    <div class="mb-2" v-if="consultant.intro">
                        <strong>个人简介：</strong>
                        <p class="text-muted mb-0" style="white-space: pre-wrap;">{{ consultant.intro }}</p>
                    </div>
                </div>
                <div class="card-footer bg-light">
                    <small class="text-muted">ID: {{ consultant.id }}</small>
                </div>
            </div>
        </div>
    </div>

    <!-- 空状态提示 -->
    <div v-if="!filteredConsultants || filteredConsultants.length === 0" class="alert alert-info text-center">
        <h5>暂无咨询师信息</h5>
        <p class="mb-0">请调整筛选条件或联系管理员添加咨询师数据</p>
    </div>

    <!-- 返回首页按钮 -->
    <div class="text-center mt-4">
        <a href="/index.html" class="btn btn-outline-primary">返回首页</a>
    </div>
</div>

<!-- 引入JS资源 -->
<script src="/js/vue.global.js"></script>
<script src="/js/axios.min.js"></script>
<script src="/js/tools.js"></script>
<script>
    const { createApp } = Vue;
    createApp({
        data() {
            return {
                consultants: [],           // 所有咨询师数据
                filteredConsultants: [],   // 筛选后的咨询师数据
                filterType: "0",           // 筛选类型：0=全部，1=大学，2=企业
                searchKeyword: ""          // 搜索关键词
            };
        },
        mounted() {
            // 页面加载时获取咨询师数据
            this.loadConsultants();
        },
        methods: {
            /**
             * 从后端加载所有咨询师数据
             */
            async loadConsultants() {
                try {
                    const response = await axios.get("/api/consultants");
                    console.log("完整响应对象:", response);
                    console.log("响应是否为数组:", Array.isArray(response));
                    console.log("响应长度:", response?.length);
                    
                    // 修正：axios 返回的 response 直接就是数据数组，不需要 .data
                    const data = Array.isArray(response) ? response : [];
                    this.consultants = data;
                    this.filteredConsultants = data;
                    
                    console.log("✅ 成功加载咨询师数据，共", this.filteredConsultants.length, "条");
                } catch (error) {
                    console.error("❌ 加载错误详情:", error);
                    alert("加载咨询师数据失败：" + (error.response?.data?.msg || "服务器异常"));
                }
            },
            /**
             * 筛选咨询师数据
             */
            filterConsultants() {
                let result = this.consultants;

                // 按类型筛选
                if (this.filterType !== "0") {
                    result = result.filter(c => c.type === parseInt(this.filterType));
                }

                // 按关键词搜索（姓名、电话、学校、企业）
                if (this.searchKeyword.trim() !== "") {
                    const keyword = this.searchKeyword.trim().toLowerCase();
                    result = result.filter(c => {
                        return c.name.toLowerCase().includes(keyword) ||
                               c.phone.includes(keyword) ||
                               (c.school && c.school.toLowerCase().includes(keyword)) ||
                               (c.company && c.company.toLowerCase().includes(keyword));
                    });
                }

                this.filteredConsultants = result;
            },
            /**
             * 重置筛选条件
             */
            resetFilter() {
                this.filterType = "0";
                this.searchKeyword = "";
                this.filteredConsultants = this.consultants;
            },
            /**
             * 身份证号脱敏显示（保留前6位和后4位）
             */
            maskIdCard(idCard) {
                if (!idCard || idCard.length < 10) return idCard;
                return idCard.substring(0, 6) + "****" + idCard.substring(idCard.length - 4);
            }
        }
    }).mount('#consultantApp');
</script>
</body>
</html>
