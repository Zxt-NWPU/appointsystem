<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>咨询记录管理</title>
  <!-- 引入样式资源 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
<div class="container mt-5" id="recordApp">
  <h2 class="mb-4 text-primary">咨询记录管理</h2>
  <!-- 完善记录表单 -->
  <div class="card mb-5">
    <div class="card-header bg-light">
      <h5 class="mb-0">完善咨询记录</h5>
    </div>
    <div class="card-body">
      <form @submit.prevent="completeRecord">
        <div class="row mb-3">
          <div class="col-md-6">
            <label for="recordId" class="form-label">预约记录ID <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="recordId" v-model="record.id" placeholder="请输入预约时生成的ID">
          </div>
          <div class="col-md-6">
            <label for="endTime" class="form-label">咨询结束时间 <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="endTime" v-model="record.endTime" placeholder="格式：yyyy-MM-dd HH:mm">
          </div>
        </div>
        <div class="mb-3">
          <label for="question" class="form-label">咨询问题 <span class="text-danger">*</span></label>
          <textarea class="form-control" id="question" v-model="record.question" rows="2" placeholder="请描述学生咨询的问题"></textarea>
        </div>
        <div class="mb-3">
          <label for="conclusion" class="form-label">咨询结论 <span class="text-danger">*</span></label>
          <textarea class="form-control" id="conclusion" v-model="record.conclusion" rows="2" placeholder="请填写咨询后的结论或建议"></textarea>
        </div>
        <button type="submit" class="btn btn-primary">提交完善</button>
        <a href="/index.html" class="btn btn-outline-primary ms-2">返回首页</a>
      </form>
    </div>
  </div>
  <!-- 导出记录区域 -->
  <div class="card">
    <div class="card-header bg-light">
      <h5 class="mb-0">导出咨询记录</h5>
    </div>
    <div class="card-body">
      <div class="row align-items-center mb-3">
        <div class="col-md-4">
          <label class="form-label">选择导出格式 <span class="text-danger">*</span></label>
          <select class="form-select" v-model="exportFormat" @change="formatChange">
            <option value="json">JSON格式（易读，便于后续解析）</option>
            <option value="xml">XML格式（标准结构化格式）</option>
            <option value="txt">TXT格式（下划线分割，简洁）</option>
          </select>
        </div>
        <div class="col-md-8">
          <button class="btn btn-success" @click="exportAllRecords">导出所有咨询记录</button>
          <span class="text-muted ms-3" v-if="recordCount !== null">当前系统共有 {{ recordCount }} 条咨询记录</span>
        </div>
      </div>
      <!-- 导出格式说明 -->
      <div class="alert alert-info p-2">
        <small>
          <strong>格式说明：</strong><br>
          - JSON：键值对结构，适合程序解析；<br>
          - XML：标签化结构，适合跨系统数据交换；<br>
          - TXT：字段用下划线分割（id_学生姓名_咨询师姓名_...），适合快速查看。
        </small>
      </div>
    </div>
  </div>
</div>

<!-- 引入JS资源（含XML处理库） -->
<script src="/js/vue.global.js"></script>
<script src="/js/axios.min.js"></script>
<script src="/js/xml-js.min.js"></script>
<script src="/js/tools.js"></script>
<script>
  const { createApp } = Vue;
  createApp({
      data() {
          return {
              // 待完善的记录信息
              record: {
                  id: "",
                  endTime: "",
                  question: "",
                  conclusion: ""
              },
              // 导出相关配置
              exportFormat: "json", // 默认导出JSON格式
              recordCount: null     // 记录总数
          };
      },
      mounted() {
          // 页面加载时获取记录总数
          this.getRecordCount();
          // 从 URL 参数中获取预约 ID
          this.loadRecordIdFromUrl();
      },
      methods: {
          /**
           * 从 URL 参数中加载预约 ID
           */
          loadRecordIdFromUrl() {
              const urlParams = new URLSearchParams(window.location.search);
              const recordId = urlParams.get('id');
              if (recordId) {
                  this.record.id = recordId;
              }
          },
          /**
           * 完善咨询记录
           */
          async completeRecord() {
              // 1. 校验输入
              if (!this.record.id || !this.record.endTime || !this.record.question || !this.record.conclusion) {
                  alert("请填写完整的记录信息！");
                  return;
              }
              // 2. 校验结束时间格式
              if (!checkTimeFormat(this.record.endTime)) {
                  alert("结束时间格式错误！请按yyyy-MM-dd HH:mm填写");
                  return;
              }
              // 3. 调用后端接口更新记录
              try {
                  await axios.put(`/api/records/${this.record.id}`, this.record);
                  alert("记录完善成功！");
                  // 4. 重置表单
                  this.record = {
                      id: "",
                      endTime: "",
                      question: "",
                      conclusion: ""
                  };
                  // 5. 刷新记录总数
                  this.getRecordCount();
              } catch (error) {
                  alert("完善失败：" + (error.response?.data?.msg || "记录ID不存在或服务器异常"));
                  console.error("完善记录错误：", error);
              }
          },
          /**
           * 获取咨询记录总数
           */
          async getRecordCount() {
              try {
                  const response = await axios.get("/api/records/count");
                  this.recordCount = response.data;
              } catch (error) {
                  this.recordCount = "未知";
                  console.error("获取记录总数错误：", error);
              }
          },
          /**
           * 导出所有咨询记录
           */
          async exportAllRecords() {
              if (this.recordCount === 0 || this.recordCount === "未知") {
                  alert("当前无咨询记录可导出，或无法获取记录总数！");
                  return;
              }
              try {
                  // 1. 获取所有记录数据
                  const response = await axios.get("/api/records");
                  const records = response.data;
                  let fileContent = "";
                  let fileName = `consult_records_${new Date().getTime()}`;
                  let contentType = "";

                  // 2. 根据选择的格式处理内容
                  switch (this.exportFormat) {
                      case "json":
                          fileContent = JSON.stringify(records, null, 2);
                          fileName += ".json";
                          contentType = "application/json";
                          break;
                      case "xml":
                          // 使用xml-js库将JS对象转换为XML
                          fileContent = window.XMLjs.js2xml(records, {
                              compact: true,
                              spaces: 2,
                              root: { name: "consult_records" }, // 根标签
                              elementNameFn: (key) => key.replace(/([A-Z])/g, "_$1").toLowerCase() // 驼峰转下划线
                          });
                          fileName += ".xml";
                          contentType = "application/xml";
                          break;
                      case "txt":
                          // TXT格式：下划线分割字段
                          fileContent = records.map(record =>
                              `${record.id}_${record.studentName}_${record.consultantName}_${record.roomNo}_${record.startTime}_${record.endTime}_${record.question.replace(/_/g, "-")}_${record.conclusion.replace(/_/g, "-")}`
                          ).join("\n");
                          fileName += ".txt";
                          contentType = "text/plain";
                          break;
                  }

                  // 3. 调用工具函数下载文件
                  downloadFile(fileContent, fileName, contentType);
                  alert("导出成功！文件已开始下载");
              } catch (error) {
                  alert("导出失败：" + (error.response?.data?.msg || "服务器异常，请稍后重试"));
                  console.error("导出记录错误：", error);
              }
          },
          /**
           * 格式选择变化时的提示
           */
          formatChange() {
              const formatName = this.exportFormat.toUpperCase();
              alert(`已选择${formatName}格式，点击"导出"按钮即可下载该格式的记录文件`);
          }
      }
  }).mount('#recordApp');
</script>
</body>
</html>
